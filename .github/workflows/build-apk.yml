name: Build and Release APK

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Generate Hive adapters
      run: flutter pub run build_runner build --delete-conflicting-outputs
    
    - name: Build APK
      run: flutter build apk --release
    
    - name: Rename APK
      run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/wms-testing-v${{ github.run_number }}.apk
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: wms-testing-apk
        path: build/app/outputs/flutter-apk/wms-testing-v${{ github.run_number }}.apk
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/app/outputs/flutter-apk/wms-testing-v${{ github.run_number }}.apk
        body: |
          ## WMS Testing App - Release
          
          ### üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª –Ω–∏–∂–µ
          2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–∞ Android
          3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          
          ### ‚ú® –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
          - Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å Clean Architecture
          - 25 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ WMS —Å–∏—Å—Ç–µ–º–∞–º
          - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å Hive
          - Material Design 3 —Ç–µ–º–∞ (—Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è)
          - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          
          ### üìö –§—É–Ω–∫—Ü–∏–∏
          - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞–Ω–∏–π –ø–æ WMS
          - 15+ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤–æ–ø—Ä–æ—Å–æ–≤
          - 4 —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
          - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
          - –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Development Release (on push to main)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: dev-build-${{ github.run_number }}
        name: Development Build ${{ github.run_number }}
        prerelease: true
        files: build/app/outputs/flutter-apk/wms-testing-v${{ github.run_number }}.apk
        body: |
          ## üîß Development Build ${{ github.run_number }}
          
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏–∑ –≤–µ—Ç–∫–∏ main.
          
          ### üì± –°–∫–∞—á–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
          1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª –Ω–∏–∂–µ
          2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
          3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          
          **‚ö†Ô∏è –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ - –º–æ–≥—É—Ç –±—ã—Ç—å –±–∞–≥–∏!**
          
          ### –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç
          ${{ github.event.head_commit.message }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
